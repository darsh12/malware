#define __STDC_WANT_LIB_EXT1__ 1

#include <stdio.h>
#include <stdlib.h>
#include <io.h>
#include <string.h>
#include <winsock2.h>

#define HOST_NAME "127.0.0.1"
#define PORT_NUMBER 50000

void exfiltrate()
{
	//----------------------------------------------
	// declare variables

	int sockfd, port;
	struct sockaddr_in srv_addr;
	struct hostent *cmdserver;
	DWORD err;
	//buffer to read
	char buffer[512];

	//----------------------------------------------
	// initialization

	port = PORT_NUMBER;
	sockfd = socket(AF_INET, SOCK_STREAM, 0);

	if (sockfd < 0)
		printf("Failed to init socket file descriptor");

	cmdserver = gethostbyname(HOST_NAME);

	if (cmdserver == NULL) {
		err = WSAGetLastError();
		if (err != 0)
			printf("gethostbyname error: %ld\n", err);
	}

	memset((char *)&srv_addr, 0, sizeof(srv_addr));
	srv_addr.sin_family = AF_INET;
	memcpy((char *)&srv_addr.sin_addr.s_addr, (char *)cmdserver->h_addr, cmdserver->h_length);
	srv_addr.sin_port = htons(port);
	if (connect(sockfd, (struct sockaddr *) &srv_addr, sizeof(srv_addr)) < 0)
		printf("connection failed");


	// unit test: send text
	printf("Text: ");
	memset_s(buffer, sizeof(buffer), 0, 512);
	fgets(buffer, 511, stdin);
	if (_write(sockfd, buffer, strlen(buffer)) < 0)
		printf("write socket failure");

	// unit test: read text
	memset(buffer, 0, 512);
	if (_read(sockfd, buffer, 511) < 0)
		printf("read socket failure");
	printf("%s\n", buffer);

	// close up
	_close(sockfd);
}

int main(int argc, char *argv[])
{
	exfiltrate();
	return 0;
}